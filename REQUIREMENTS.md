# Twitter RSS Collector with Discord/Notion Notifications
## 要件定義書 v2.0

---

## 1. システム概要

### 1.1 目的
Composio REST APIとGoogle Apps Script（GAS）を組み合わせて、X（Twitter）の情報をRSS形式で取得し、Discord・Notionへ通知を送信するシステムを構築する。

### 1.2 主要機能
1. **Twitter RSS収集**: Composio経由でTwitterの検索結果をRSS形式で提供
2. **ユーザー検索**: 特定ユーザーのツイートを監視（`from:username`）
3. **キーワード検索**: 特定キーワードのツイートを監視
4. **6時間フィルター**: 6時間以内のツイートのみを取得（1日4回トリガー対応）
5. **設定シート**: スプレッドシートで検索条件を管理
6. **ログシート**: 実行履歴を自動記録
7. **Discord通知**: 新規ツイート検出時にDiscordへ通知
8. **Notion通知**: 新規ツイート検出時にNotionデータベースへ追加

---

## 2. 機能要件

### 2.1 設定シート（⚙️ 設定）

#### 2.1.1 概要
スプレッドシートで検索条件を一元管理。ユーザーが追加・編集・有効/無効を切り替え可能。

#### 2.1.2 カラム構成
| カラム | 説明 | タイプ | 備考 |
|--------|------|--------|------|
| A: 有効 | 検索を実行するか | チェックボックス | falseの行はグレーアウト |
| B: 検索タイプ | ユーザー or キーワード | ドロップダウン | 選択式 |
| C: 検索値 | ユーザー名 or 検索ワード | テキスト | @なしでOK |
| D: 最大取得件数 | 1回あたりの取得数 | 数値 | デフォルト10 |
| E: Discord通知 | Discordへ通知するか | チェックボックス | |
| F: Notion通知 | Notionへ追加するか | チェックボックス | |
| G: 最終実行 | 最後に実行した日時 | 日時（自動） | 自動更新 |
| H: 最終取得ID | 最後に取得したツイートID | テキスト（自動） | 重複防止用 |
| I: メモ | 自由記述 | テキスト | 通知にも表示 |

#### 2.1.3 サンプルデータ
| 有効 | 検索タイプ | 検索値 | 最大取得件数 | Discord | Notion | メモ |
|------|-----------|--------|-------------|---------|--------|------|
| ✅ | ユーザー | openai | 10 | ✅ | ✅ | OpenAI公式 |
| ✅ | ユーザー | anthropic | 10 | ✅ | ✅ | Anthropic公式 |
| ✅ | キーワード | AI 人工知能 lang:ja | 15 | ✅ | ❌ | 日本語AI |
| ❌ | キーワード | #ChatGPT | 10 | ✅ | ✅ | 無効化中 |

---

### 2.2 ログシート（📋 ログ）

#### 2.2.1 概要
実行履歴を自動記録。成功/エラーの可視化、デバッグに活用。

#### 2.2.2 カラム構成
| カラム | 説明 |
|--------|------|
| A: 実行日時 | ログ記録日時 |
| B: 検索タイプ | ユーザー or キーワード |
| C: 検索値 | 実行した検索条件 |
| D: ステータス | ✅ 成功 / ❌ エラー / ⚠️ スキップ |
| E: 取得件数 | API から取得した件数 |
| F: 新規件数 | 重複除外後の新規件数 |
| G: Discord通知 | 送信件数 |
| H: Notion通知 | 追加件数 |
| I: エラー内容 | エラー発生時の詳細 |
| J: 処理時間(ms) | 検索ごとの処理時間 |

#### 2.2.3 条件付き書式
- **✅ 成功**: 緑背景
- **❌ エラー**: 赤背景

---

### 2.3 トリガー設定（6時間ごと）

#### 2.3.1 概要
1日4回（6時間ごと）に自動実行し、6時間以内のツイートを取得。

#### 2.3.2 仕様
| 項目 | 値 |
|------|-----|
| 実行関数 | `runAllSearches` |
| 実行間隔 | 6時間ごと |
| 時間フィルター | 6時間以内のツイートのみ |
| 重複防止 | 最終取得IDより新しいもののみ |

#### 2.3.3 メニュー操作
- **⏰ トリガー設定（6時間ごと）**: トリガーを作成
- **🗑️ トリガー削除**: トリガーを削除

---

### 2.4 サイドバーUI（APIキー設定）

#### 2.4.1 概要
- GASの`onOpen`関数でスプレッドシートメニューに「🐦 Twitter RSS」メニューを追加
- メニューから「⚙️ API設定」を選択するとサイドバーを表示
- サイドバーでAPIキー、Webhook URL等の機密情報を入力・保存

#### 2.4.2 入力項目
| フィールド名 | 説明 | 必須 |
|-------------|------|------|
| Composio API Key | Composioの認証キー | ✅ |
| Connected Account ID | TwitterのConnected Account ID | ✅ |
| Discord Webhook URL | Discord通知用WebhookのURL | ❌ |
| Notion API Key | Notion APIの認証キー | ❌ |
| Notion Database ID | Notion通知先のデータベースID | ❌ |

#### 2.4.3 機密情報マスク表示機能
- **要件**: 各入力欄の機密情報をマスク表示（●●●●●●）
- **初期状態**: `type="password"`でマスク表示
- **切り替え**: 目玉アイコン（👁）ボタンをクリックで表示/非表示を切り替え
- **表示状態**: `type="text"`で実際の値を表示

---

### 2.5 ヘルプダイアログUI

#### 2.5.1 概要
- メニューから「❓ ヘルプ」を選択するとダイアログを表示
- 操作方法、設定手順、トラブルシューティングを案内

#### 2.5.2 ヘルプ内容
1. **クイックスタートガイド**
2. **設定項目の説明**
3. **使い方**
4. **検索クエリの書き方**
5. **トラブルシューティング**

---

### 2.6 Discord通知機能

#### 2.6.1 通知内容
```json
{
  "embeds": [{
    "title": "🐦 新規ツイート検出",
    "description": "${tweet.text}",
    "url": "https://twitter.com/i/status/${tweet.id}",
    "color": 5793266,  // ユーザー検索: 紫, キーワード検索: 青
    "fields": [
      {"name": "検索条件", "value": "${searchType}: ${searchValue}", "inline": true},
      {"name": "📅 投稿日時", "value": "${tweet.created_at}", "inline": true}
    ],
    "footer": {"text": "Twitter RSS Collector | ${memo}"}
  }]
}
```

---

### 2.7 Notion通知機能

#### 2.7.1 データベーススキーマ
| プロパティ名 | タイプ | 説明 |
|-------------|--------|------|
| Title | Title | ツイート本文（最初の100文字） |
| Author | Rich Text | ツイート投稿者 |
| URL | URL | ツイートへのリンク |
| Created At | Date | ツイート投稿日時 |
| Collected At | Date | 収集日時 |
| Query | Select | 検索タイプ + 検索値 |
| Search Type | Select | ユーザー or キーワード |

---

## 3. UI仕様

### 3.1 メニュー構成
```
🐦 Twitter RSS
├── ⚙️ API設定
├── ─────────────
├── 📝 設定シートを初期化
├── 📋 ログシートを初期化
├── ─────────────
├── ▶️ 今すぐ実行（全検索）
├── 📤 通知テスト
├── 🔄 RSS取得テスト
├── ─────────────
├── ⏰ トリガー設定（6時間ごと）
├── 🗑️ トリガー削除
├── ─────────────
└── ❓ ヘルプ
```

### 3.2 設定シートレイアウト
```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│ 有効 │ 検索タイプ │ 検索値              │ 最大取得 │ Discord │ Notion │ 最終実行          │ 最終取得ID │ メモ           │
├───────────────────────────────────────────────────────────────────────────────────────────┤
│ [✓] │ ユーザー   │ openai              │ 10       │ [✓]     │ [✓]    │ 2026/01/08 12:00 │ 123456...  │ OpenAI公式     │
│ [✓] │ キーワード │ AI 人工知能 lang:ja │ 15       │ [✓]     │ [ ]    │ 2026/01/08 12:00 │ 789012...  │ 日本語AI       │
│ [ ] │ キーワード │ #ChatGPT            │ 10       │ [✓]     │ [✓]    │                  │            │ 無効化中       │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. ファイル構成

```
twitter-to-rss-gas/
├── Code.gs              # メインGASコード
├── Sidebar.html         # サイドバーUI（API設定）
├── Help.html            # ヘルプダイアログUI
├── appsscript.json      # マニフェストファイル
├── REQUIREMENTS.md      # 本要件定義書
└── context.md           # コンテキスト情報
```

---

## 5. 処理フロー

### 5.1 定期実行フロー
```
┌─────────────┐
│ トリガー発火 │
│ (6時間ごと) │
└──────┬──────┘
       ↓
┌─────────────────┐
│ runAllSearches  │
└──────┬──────────┘
       ↓
┌─────────────────────────┐
│ 設定シートから          │
│ 有効な検索条件を取得    │
└──────┬──────────────────┘
       ↓
┌─────────────────────────┐
│ 各検索条件をループ      │◄────────┐
└──────┬──────────────────┘         │
       ↓                            │
┌─────────────────────────┐         │
│ クエリを構築            │         │
│ (from:user or keyword)  │         │
└──────┬──────────────────┘         │
       ↓                            │
┌─────────────────────────┐         │
│ Composio API呼び出し    │         │
└──────┬──────────────────┘         │
       ↓                            │
┌─────────────────────────┐         │
│ 6時間以内フィルター     │         │
└──────┬──────────────────┘         │
       ↓                            │
┌─────────────────────────┐         │
│ 新規ツイートフィルター  │         │
│ (最終取得ID以降)        │         │
└──────┬──────────────────┘         │
       ↓                            │
┌─────────────────────────┐         │
│ Discord/Notion通知      │         │
└──────┬──────────────────┘         │
       ↓                            │
┌─────────────────────────┐         │
│ 設定シート更新          │         │
│ (最終実行、最終取得ID)  │         │
└──────┬──────────────────┘         │
       ↓                            │
┌─────────────────────────┐         │
│ ログシートに記録        │         │
└──────┬──────────────────┘         │
       │                            │
       └───── 次の検索条件 ─────────┘
```

---

## 6. Twitter検索クエリの例

### 6.1 ユーザー検索（検索タイプ: ユーザー）
| 検索値 | 生成されるクエリ | 説明 |
|--------|-----------------|------|
| openai | from:openai | OpenAI公式のツイート |
| @elonmusk | from:elonmusk | @は自動除去 |

### 6.2 キーワード検索（検索タイプ: キーワード）
| 検索値 | 説明 |
|--------|------|
| AI 人工知能 | AND検索 |
| AI OR 機械学習 | OR検索 |
| #ChatGPT | ハッシュタグ |
| AI lang:ja | 日本語のみ |
| AI -広告 -PR | 除外キーワード |
| AI min_retweets:100 | 最小RT数 |

---

## 7. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2026-01-08 | 初版作成 |
| 2.0 | 2026-01-08 | 設定シート・ログシート機能追加、6時間フィルター対応 |

